---
title: "05-LandcoverData"
author: "Dimitrios Markou"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Chapter 5: Land Cover Data

##### Authors: Dimitrios Markou, Danielle Ethier

> In [Chapter 4](04-ElevationData.Rmd), you processed Digital Terrain Models, applied crop, mask, and reclassification procedures, and extracted elevation values to combine with NatureCounts data. In this tutorial, you will extract unique pixel values from land cover data over [La Mauricie National Park](https://parks.canada.ca/pn-np/qc/mauricie/nature) and combine these values to NatureCounts data from the [Quebec Breeding Bird Atlas (2010 - 2014)](https://naturecounts.ca/nc/default/datasets.jsp?code=QCATLAS2PC&sec=bmdr).

**Land cover** describes the surface cover on the ground like vegetation, urban, water, and bare soil while **land use** describes the purpose that the land serves like recreation, wildlife habitat, and agriculture. See [Land Cover & Land Use](https://natural-resources.canada.ca/maps-tools-and-publications/satellite-imagery-elevation-data-and-air-photos/tutorial-fundamentals-remote-sensing/educational-resources-applications/land-cover-land-use/land-cover-land-use/9373) from Natural Resources Canada for more information.

**To proceed with this tutorial, download the necessary packages in [5.0 Learning Objectives] and complete section 4.1 Data Setup from [Chapter 4: Elevation Data](04-ElevationData.Rmd)**. **It helps you download the National Park boundary and NatureCounts data which are required for this lesson. Alternatively, you can access these files in the [data folder](https://github.com/BirdsCanada/NatureCounts_SpatialData_Tutorial/tree/d83eed714373048c8f9fdb4ea4a17f1fd4bef3f7/Data) we have created in the [NatureCounts_SpatialData_Tutorial](https://github.com/BirdsCanada/NatureCounts_SpatialData_Tutorial.git) repository. Make sure to grab the *.shp* file as well as ALL accompanying files.**

# 5.0 Learning Objectives

By the end of **Chapter 5 - Land Cover Data**, users will know how to:

-   Load and process land cover data (raster)
-   Extract unique pixel values from a raster data set
-   Combine NatureCounts data with land cover data for analysis

This R tutorial requires the following packages:

```{r, eval = TRUE, warning = FALSE, message = FALSE}
library(naturecounts)
library(sf)
library(terra)
library(tidyverse)
library(lubridate)
library(leaflet)
library(leaflet.extras)
```

This tutorial uses the following spatial data.

1.  [Places administered by Parks Canada](https://open.canada.ca/data/en/dataset/e1f0c975-f40c-4313-9be2-beb951e35f4e/resource/0744186a-449b-4f1f-9f1e-952a94c6d5ca) - Boundary shapefiles

2.  [2015 Land Cover of Canada](https://open.canada.ca/data/en/dataset/4e615eae-b90c-420b-adee-2ca35896caf6) - Land Cover map (30 m resolution)

3.  [Quebec Breeding Bird Atlas (2010 - 2014)](https://naturecounts.ca/nc/default/datasets.jsp?code=QCATLAS2PC&sec=bmdr) - NatureCounts bird observations

# 5.1 Land Cover Data

To read in the land cover dataset, navigate to [2015 Land Cover of Canada](https://open.canada.ca/data/en/dataset/4e615eae-b90c-420b-adee-2ca35896caf6), scroll down to **Data and Resources** and select either data labeled `web_service` and `WMS` (English). Extract the data download and save the file to your directory before applying `terra::rast()`.

```{r}
#if the data are in your working directory
landcover <- rast("landcover-2015-classification.tif")

#else, specify the location of your data
landcover<-rast("path/to/your/landcover-2015-classification.tif")
```

Transform the crs of the National Park boundary to match that of the land cover dataset.

```{r}
mauricie_boundary <- st_transform(mauricie_boundary, crs = st_crs(landcover))
```

Crop the national dataset to reduce the extent of the raster to the extent of the National Park.

```{r}
landcover_crop <- crop(landcover, vect(mauricie_boundary))
```

OPTIONAL: To write the cropped raster to your disk, you can use the `writeRaster()` function from `terra`. **This raster will be useful to complete [Chapter 7: Raster Summary Tools](07-RasterSummaryTools.Rmd)**. You must complete the above sections and save this raster to proceed with Chapter 7 unless you're using your own data.

> To execute this code chunk, remove the \#

```{r}
# output_path <- "C:/Users/dimit/Birds Canada/Data/mauricie/landcover_crop.tif" 

# writeRaster(landcover_crop, output_path, datatype = "INT1U", overwrite = TRUE)
```

To assign the land cover class label and pixel count to each pixel value we can use the `unique()` function, assign land cover class labels (see [Class Index](https://open.canada.ca/data/en/dataset/ee1580ab-a23d-4f86-a09b-79763677eb47/resource/b8411562-49b7-4cf6-ac61-dbb893b182cc)), and apply the `freq()` function.

```{r}
# Extract the unique pixel values from the cropped landcover raster
unique_values <- unique(landcover_crop)

# Assign land cover class labels according to the pixel values (in the correct order)
unique_values$landcover <- c("needleleaf", "broadleaf", "mixed forest", "shrubland", "grassland", "wetland", "cropland", "barren", "urban", "water")

# Add pixel count for each class
pixel_freq <- freq(landcover_crop)
unique_values$pixelcount <- pixel_freq$count

unique_values
```
Apply  the `levels()` and `data.frame()` functions to add the pixel values, landcover classes, and pixel count to the raster data.

```{r}
levels(landcover_crop) <- data.frame(
  pixelvalue = unique_values$Canada2015,
  landcover = unique_values$landcover,    
  pixelcount = unique_values$pixelcount        
)
```

Plot the land cover raster and National Park boundary.

```{r, eval = TRUE, warning = FALSE}
# Match the CRS
mauricie_boundary <- st_transform(mauricie_boundary, crs = st_crs(landcover_crop))

# Plot landcover
plot(landcover_crop, axes = TRUE, plg = list(title = "Landcover"), main = "La Mauricie National Park - Landcover 2015")

# Overlay the Mauricie boundary on the first plot
plot(mauricie_boundary, add = TRUE, border = "red", col = NA, lwd = 2)
```
Mask the national dataset and apply NA values to all cells outside the extent of the National Park.

```{r}
landcover_mask <- mask(landcover_crop, vect(mauricie_boundary))
```

OPTIONAL: To write the masked raster to your disk, you can use the `writeRaster()` function from `terra`. **This raster will be useful to complete [Chapter 7: Raster Summary Tools](07-RasterSummaryTools.Rmd)**. You must complete the above sections and save this raster to proceed with Chapter 7 unless you're using your own data.

> To execute this code chunk, remove the \#

```{r}
output_path <- "C:/Users/dimit/Birds Canada/Data/mauricie/landcover_mask.tif"

writeRaster(landcover_mask, output_path, datatype = "INT1U", overwrite = TRUE)
```

Summarize the NatureCounts data for mapping and covert it to SpatVector format.

```{r}
# Group by SiteCode and summarize total_count
mauricie_site_summary <- mauricie_birds %>%
  group_by(SiteCode) %>%
  summarize(total_count = sum(ObservationCount, na.rm = TRUE))
```

```{r}
mauricie_birds_vect <- vect(mauricie_birds) # Converts to SpatVector format
```

Now we can map the NatureCounts and land cover data.

```{r}
mauricie_site_summary <- st_transform(mauricie_site_summary, crs = st_crs(landcover_crop)) # Match the CRS

# Plot landcover raster for La Mauricie National Park
plot(landcover_crop, main = "Landcover across La Mauricie National Park")

# Overlay the National Park boundary in red
plot(st_geometry(mauricie_boundary), col = NA, border = "red", add = TRUE)

# Overlay the multipoints from the site summary in blue
plot(st_geometry(mauricie_site_summary), 
     add = TRUE, 
     pch = 19,      # Solid circle
     col = "yellow",  # Point color
     cex = 0.5)     # Point size
```

Extract pixel values for each bird observation site and append it to `mauricie_birds`.

```{r}
mauricie_birds <- st_transform(mauricie_birds, crs(landcover_crop)) # Match the CRS

pixel_values <- terra::extract(landcover_crop, mauricie_birds_vect) # Extracts the NDVI values for each point

pixel_values <- cbind(record_id = mauricie_birds$record_id, pixel_ID = pixel_values[, 2]) # Creates the record_id and pixel_ID columns 
```

**Congratulations**! You completed **Chapter 5 - Land Cover Data**. In this chapter, you successfully plotted land cover (raster) data, extracted unique pixel values, and combined them with NatureCounts data. In [Chapter 6](06-SatelliteImagery.Rmd), you can explore how to download satellite imagery and calculate spectral indices to combine with NatureCounts data.
