---
title: "03-EnvironmentalData"
author: "Dimitrios Markou"
date: "2024-08-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Chapter 3 Environmental Data

##### Author: Dimitrios Markou

# 3.0 Learning Objectives

By the end of **Chapter 3 - EnvironmentalData**, users will know how to:

-   Process digital elevation model and landcover data
-   Calculate Normalized Difference Vegetation Index (NDVI)
-   Link NatureCounts data to environmental data

This R tutorial requires the following packages:

```{r, eval = TRUE, warning = FALSE, message = FALSE}
library(naturecounts)
library(sf)
library(terra)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggspatial)
library(mapview)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
```

# 3.1 Study Area - La Mauricie National Park

Read in the National Park polygons:

```{r}
national_parks <- st_read("C:/Users/dimit/Birds Canada/Data/nationalparks/vw_Places_Public_lieux_public_APCA.shp")
```

```{r}
mauricie_boundary <- national_parks %>%
  filter(OBJECTID == "21")
```

# 3.2 NatureCounts Data

Explore the NatureCounts collections:

```{r}
collections <- meta_collections()
View(meta_collections())
```

In this example, we will use data from the Quebec Breeding Bird Atlas ...

Download data from NatureCounts:

```{r}
quebec_atlas <- nc_data_dl(collections = "BCATLAS1BE_RAW", region = list(subnational2 = "CA.BC.CP"), username = "testuser", info = "spatial_data_tutorial")
```

Convert the NatureCounts data to a spatial object:

```{r}

```

Clip the NatureCounts data to the area of interest using geoprocessing functions:

```{r}

```

# 3.3 DEM, DSM & DTM

BLURB on DEM vs DTM vs DSM LiDAR-derived products

Set the path to your TIF file directory:

```{r, eval = FALSE}
dir_path <- "path/to/your/directory"
```

```{r, eval = TRUE, echo = FALSE}
dir_path <- "C:/Users/dimit/Birds Canada/Data/mauricie"
```

Create a mosaic of the adjacent DTM rasters:

```{r, eval = TRUE}
# list all the TIFF files in your directory
dtm_files <- list.files(dir_path, pattern = "\\.tif$", full.names = TRUE)

# Read into a list of SpatRaster objects
dtm_list <- lapply(dtm_files, rast)

# Combine into a single SpatRaster object
dtm_mosaic <- do.call(mosaic, dtm_list)

# Print information about the stack
print(dtm_mosaic)
```

Let's check if the DTM and national park boundary have the same crs by using the `st_crs` function and equality operator (**==**) which will generate either TRUE or FALSE:

```{r, eval = TRUE}
st_crs(dtm_mosaic) == st_crs(mauricie_boundary)
```

To reproject the spatial data with the same crs, we can use the `st_transform` function:

```{r}
mauricie_boundary <- st_transform(mauricie_boundary, crs = st_crs(dtm_mosaic))
```

We can then use the base `plot` function to visualize the terrain of Mauricie National Park:

```{r, eval = TRUE, warning = FALSE}
# Plot the DTM mosaic
plot(dtm_mosaic, main = "DTM Mosaic with La Mauricie Boundary")

# Overlay the National Park boundary
plot(mauricie_boundary, add = TRUE, border = "red", col = NA, lwd = 2)
```

# 3.4 Cropping and masking

**Cropping** reduces the extent of a raster to the extent of another raster or vector.

**Masking** assigns NA values to cells of a raster not covered by a vector.

To mask a raster to a vector extent we will use the `mask` function from the `terra` package which uses the SpatVector format. Here, we create the mask while converting the National Park Boundary to a SpatVector: 
```{r, warning = FALSE}
mauricie_mask <- mask(dtm_mosaic, vect(mauricie_boundary))
```
Visualize the output from 

```{r}
# Set up a 1x2 plotting layout
par(mfrow = c(1, 2))

# Plot dtm_mosaic
plot(dtm_mosaic, main = "regional DTM")

# Plot mauricie_mask
plot(mauricie_mask, main = "mask DTM")
```




```{r}
mauricie_mask <- mask(dtm_mosaic, vect(mauricie_boundary))
```

# 3.5 Reclassification 

# 3.6 Summary Statistics

To calculate the summary statistics for the values of individual SpatRaster layers you can use the `global()` function like so:

```{r}
global(dtm_mosaic, fun = "mean", na.rm = TRUE)
```

It is also possible to make and implement a function to calculate multiple summary statistics simultaneously:

```{r}
my_summary_stats <- function(x) {
  out <- c(mean = mean(x, na.rm = TRUE), 
              sd = sd(x, na.rm = TRUE), 
              min = min(x, na.rm = TRUE), 
              max = max(x, na.rm = TRUE))
  return(out)
}
global(dtm_mosaic, fun = my_summary_stats)
```

# 4.0 Landcover Data

2020 Land Cover of Canada: <https://open.canada.ca/data/en/dataset/ee1580ab-a23d-4f86-a09b-79763677eb47/resource/81252d30-5102-46db-a9c5-6ab1ccd5dcd7>

2015 Land Cover of Canada: <https://open.canada.ca/data/en/dataset/4e615eae-b90c-420b-adee-2ca35896caf6/resource/54200576-6203-4c1f-b646-924a1df3e08b>


