---
title: "04-AnalysisTools"
author: "Dimitrios Markou"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Chapter 8 Analysis Tools

##### Author: Dimitrios Markou

# 8.0 Learning Objectives

By the end of **Chapter 8 - AnalysisTools**, users will know how to:

# 8.1 Accessing Auxillary Tables from naturecounts

nc_query_tables

Brief instructions on how to list available datasets

```{r}
rnest <- nc_query_table("Rnest")
```


# 8.2 Zero-filling

Zero-filling assigns counts of zero to species that are not detected during an observation period. Zeros can indicate two things - the true absence of a species or failure to detect a species.

Zero and non-zero counts are crucial to describe changes in bird distribution and abundance over time. Zero-filling helps discern whether or not the spatial distribution of a species is accurate and not simply a function of observer location bias. Presence-only data is quite limited in what its able to tell us.

There are two conditions that make species data eligible for zero-filling:

-   **Condition 1** - There is consistent data for observation periods when a species could have been seen although it was not actually seen.

-   **Condition 2** - We can assume that the species would have been reported if it had been detected.

There are some important considerations with regards to zero-filling. For example, the presence of **write-in species** and **variable observer effort** can impact a species' ability to meet Conditions 1 & 2 and result in lower statistical power when analyzing data. For NatureCounts records, we can infer species absence for every unique SamplingEventIdentifier when a species was not detected and all species were reported for that event (AllSpeciesReported is "Yes").

Good candidates for zero-filling are species that are reported consistently at many sites within their ranges. What is considered "many sites" depends on the species. Write-in species are those recorded outside of an expected list of species that are added by an observer based on their own motivations and efforts - these are likely poor candidates for zero-filling.

Statistical models like the **Occupancy Model** and **Generalized Linear Model** can be used to interpret zero counts.

Read in the NatureCounts data covering the National Park. 

```{r, warning = FALSE, message = FALSE}
mauricie_birds_df <- read_csv("data/mauricie/mauricie_birds_df.csv") 
```

Let's see if all species were reported.  

```{r}
count(mauricie_birds_df, AllSpeciesReported)
```
Yes! So, in this case, there is no need to filter the dataset because all species were recorded for each sampling event. 

Let's apply the `format_zero_fill()` function. Optionally, you can specify columns to retain in the output dataframe using the `extra_event` and/or `extra_species` arguments. By default, the function zero fills by `SamplingEventIdentifier`. However, the `by` argument may also be used to specify how the data should be zero-filled i.e. by `SamplingEventIdentifer`, `SurveyAreaIdentifier`, `SiteCode`, `utm_square`, etc. This is useful if you want to determine whether a species has/has not been observed in a particular zone!

```{r}
mb_df_filled <- format_zero_fill(mauricie_birds_df, 
                                 by = "SamplingEventIdentifier",
                                 extra_event = c("latitude", "longitude"),
                                 extra_species = c("scientific_name", "english_name"))
```

While `format_zero_fill()` add 0's to the `ObservationCount` column by default, you can specify other columns to zero fill. For example, you could create Presence/Absence data by zero-filling a custom column.

First, select relevant columns from the original dataframe and create a presence column based on `ObservationCount`.

```{r}
mb_df_presence <- mauricie_birds_df %>%
  select(AllSpeciesReported, SamplingEventIdentifier, species_id, ObservationCount, scientific_name, english_name, latitude, longitude) %>%
  mutate(presence = if_else(as.numeric(ObservationCount) > 0, TRUE, FALSE))
```

Zero-fill the data while specifying the presence column in the `fill` argument. This also converts the presence column from logical to numeric.

```{r}
mb_df_presence_filled <- format_zero_fill(mb_df_presence, 
                                          fill = "presence",
                                          by = "SamplingEventIdentifier",
                                          extra_event = c("latitude", "longitude"),
                                          extra_species = c("scientific_name", "english_name"))
```

# 8.3 Occupancy modeling
