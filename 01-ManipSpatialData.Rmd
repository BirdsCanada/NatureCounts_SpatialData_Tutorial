---
title: "01-ManipSpatialData"
author: "Dimitrios Markou"
date: "2024-07-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(sf)
library(terra)
library(ggplot2)
library(ggspatial)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
```

INTRO on the importance of hotspots/priority conservation areas. DESCRIPTION of KBA's and Priority Places. This chapter will explore how to read in polygon shapefiles and nature counts data and then clip and visualize this data ...

The spatial data used in this tutorial was downloaded from the [KBA Canada Map Viewer](https://kbacanada.org/explore/map-viewer/) and the ECCC's [Priority Places for Species at Risk (Terrestrial)](https://open.canada.ca/data/en/dataset/91219d24-e877-4c8a-8bd2-b2b662e573e0).

# Intro to Spatial Data

Spatial data is any type of vector or raster data that represents a feature or phenomena across geographic space.

| Vector data is used to represent features with points, lines and polygons. This may include individual bird observations, rivers, or conservation area boundaries.

| Raster data is used to represent spatially continuous data with a grid, where each cell has one value. This may include types of environmental data like elevation or temperature.

The most common format used to store vector data in a file on disk is the **ESRI Shapefile** format *(.shp)*. Shapefiles are always accompanied by files with *.dbf*, *.shx,*, and *.prj* extensions.

Raster data files are typically stored with a TIFF or GeoTIFF files with a *(.tif)* or *(.tiff)* extension. We provide a tutorial on [Raster data manipulation](#02-ManipSpatialDataPt2) in the next chapter.

# Organizing spatial data

Creating individual folders is recommended

We also might want to rename our downloaded files to something more meaningful or distinguishable on our disK. To do so, we provide this helpful function:

```{r}
# Define the original base name and the new base name
original_base_name <- "old_shapefile_name"
new_base_name <- "new_shapefile_name"

# Define the directory containing the shapefile
shapefile_directory <- "path/to/shapefile/directory"

# List of shapefile extensions
shapefile_extensions <- c(".shp", ".shx", ".dbf", ".prj", ".cpg")

# Function to rename files
rename_shapefile <- function(original_base_name, new_base_name, shapefile_directory, extensions) {
  for (ext in extensions) {
    original_file <- file.path(shapefile_directory, paste0(original_base_name, ext))
    new_file <- file.path(shapefile_directory, paste0(new_base_name, ext))
    
    if (file.exists(original_file)) {
      file.rename(original_file, new_file)
    } else {
      message(paste("File not found:", original_file))
    }
  }
}

# Rename the shapefile and its accompanying files
rename_shapefile(original_base_name, new_base_name, shapefile_directory, shapefile_extensions)
```

# Reading in spatial data

The `sf` package provides [simple feature](https://r-spatial.github.io/sf/) access in R. This package works best for working with spatial data (point, line, polygon, multipolygon etc) associated with tabular attributes (e.g shapefiles). You may be familiar with the `sp` package that has similar functionality in a different format, however, this package is heading for retirement by the end of 2023 and does not support integration with `tidyverse` which is very popular among data scientists in R.

You're interested in mapping all the KBA's currently recognized in Ontario. You navigate the [KBA Canada Map Viewer](https://kbacanada.org/explore/map-viewer/) and filter for all KBA's in the province. Now, let's read in our spatial data using the `sf` package:

```{r}
ontario_kba <- sf::st_read("C:/Users/dimit/Birds Canada/NatureCounts_SpatialData_Tutorial/Data/KBA/ProvOntario_KBA/ontario_kba.shp")
```


How can we avoid duplicates?



This shapefile is also accompanied by a CSV file with important attributes concerning our KBAs.

Let's read in the accompanying CSV file for our KBA layer:

```{r}
kba_attributes <- read.csv("Data/KBA/ProvOntario_KBA/ontario_kba.csv")
```


We can also visualize the KBA layer with an interactive map, using the leaflet package:

```{r}
leaflet(width = "100%") %>%
  addTiles() %>%
  addPolygons(data=ontario_kba,color = "black", weight = 2, smoothFactor = 1,opacity = 1.0, fillOpacity = 0.5, fillColor = "red") %>% addFullscreenControl() %>%
  addLegend(colors = c("red"),labels = c("Canadian Lake Superior"),position = "bottomright")
```

The CRS of our KBA sf object can be returned with st_crs()

```{r}
sf::st_crs(kba_layer)
```

We can also transform the CRS of our sf object

```{r}
kba_layer <- sf::st_transform(kba_layer, crs = )
```

To drop the geometry of a sf object

```{r}
kba_no_geom <- sf::st_drop_geometry(kba_layer)
```

# Applying geoprocessing functions
