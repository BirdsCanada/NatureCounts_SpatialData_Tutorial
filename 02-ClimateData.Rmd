---
title: "02-ManipSpatialData_Part2"
author: "Dimitrios Markou"
date: "2024-07-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Chapter 2: Climate Data

Spatial data mapping can help explore possible associations between species occurrences and climate or environmental variables. Integrating diverse data-sets with NatureCounts data can, therefore, help inform species distribution models, select predictor variables, and provide us clever ways to communicate our data.

In this tutorial, you will use NatureCounts and climate data to explore possible patterns in Whooping Crane observations, annual mean temperature, and annual mean precipitation within the Wood Buffalo National Park using spatio-temporal maps spanning X years.

# 2.0 Learning Objectives

By the end of **Chapter 2 - Climate Data**, users will know how to:

-   Download and preprocess climate data in R
-   Summarize climate data over a region of interest
-   Combine climate data with NatureCounts observations
-   Visualize NatureCounts and climate data using spatio-temporal maps

This tutorial utilizes the following bird occurrence, spatial, and climate data sources:

| Data                                                                                                               | Description                                                                                                                                                             |
|--------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [eBird Canada (Prairies)](https://naturecounts.ca/nc/default/datasets.jsp?code=EBIRD-CA-PR)                        | NatureCounts                                                                                                                                                            |
| Alberta Breeding Bird Atlases                                                                                      | NatureCounts, [1987-1992](https://naturecounts.ca/nc/default/datasets.jsp?code=ABATLAS1) and [2000-2005](https://naturecounts.ca/nc/default/datasets.jsp?code=ABATLAS2) |
| [Alberta Bird Records](https://naturecounts.ca/nc/default/datasets.jsp?code=ABBIRDRECS)                            | NatureCounts                                                                                                                                                            |
| [Whooping Crane Nesting Area and Summer Range](https://kbacanada.org/site/?SiteCode=NT002)                         | Key Biodiversity Area boundary (**.shp**) and site attributes                                                                                                           |
| [Environment and Climate Change Canada](https://climate.weather.gc.ca/historical_data/search_historic_data_e.html) | Historical weather data, accessed through the `weathercan` R package                                                                                                    |
| WorldClim                                                                                                          | Nineteen bioclimatic variables representing the 1950-2000 average                                                                                                       |

This R tutorial requires the following **packages**:

```{r package library, warning = FALSE, message = FALSE}
library(dplyr)
library(ggplot2)
library(sf)
library(mapview)
library(naturecounts)
library(leaflet)
library(leaflet.extras)
library(leaflet.providers)
library(ggspatial)
library(RColorBrewer)
library(raster)
library(tmap)
library(terra)

#since weathercan is not available in the recent version of R, we install the package a little differently
#install.packages("weathercan", 
                 #repos = c("https://ropensci.r-universe.dev", 
                           #"https://cloud.r-project.org"))
library(weathercan)
```

# 2.1 Preparing NatureCounts Data

Reminder that, to download data, you need to [sign up](https://naturecounts.ca/nc/default/register.jsp) for a **free** account.

> The data download will not work unless you replace `"testuser"` with your actual user name. You will be prompted to enter your password.

```{r}
collections <- meta_collections() 
View(meta_collections())
```

```{r}
search_species("whooping crane")
View(search_species("whooping crane"))
```

To download the NatureCounts data, we can specify the collection and species code:

```{r}
abatlas1_whooping <- nc_data_dl(collections = "ABATLAS1", species = 4030, username = "testuser", info = "spatial_data_tutorial")
```

```{r}
abatlas2_whooping <- nc_data_dl(collections = "ABATLAS2", species = 4030, username = "testuser", info = "spatial_data_tutorial")
```

```{r}
abirdrecs_whooping <- nc_data_dl(collections = "ABBIRDRECS", species = 4030, username = "testuser", info = "spatial_data_tutorial")
```

If you haven't done so already, accessing the eBird data will require you to have your own account as it has an Access Level 4:

```{r}
ebird_whooping <- nc_data_dl(collections = "EBIRD-CA-PR", species = 4030, username = "dimimarkou", info = "spatial_data_tutorial")
```

Combine all the Whooping Crane data together:

```{r}
whooping_crane_data <- bind_rows(abatlas1_whooping, abatlas2_whooping, abirdrecs_whooping, ebird_whooping)
whooping_crane_data
```

Next, we'll want to group the Whooping Crane data to provide more meaningful insight on species occurrence and how it might vary across time and space. First we'll create date and doy columns and make sure that the ObservationCount column is in the correct `numeric` format:

```{r}
whooping_crane_data <- whooping_crane_data %>%
  format_dates() %>% # create the date and doy columns 
  mutate(ObservationCount = as.numeric(ObservationCount)) # convert to numeric
```

Then we'll summarize species occurrence by SiteCode and date while keeping the coordinate information for each site:

```{r}
species_occurrence_summary <- whooping_crane_data %>%
  group_by(SiteCode, date, longitude, latitude) %>%
  summarise(total_count = sum(as.numeric(ObservationCount), na.rm = TRUE)) %>%
  ungroup()
```

Lastly, we'll want to summarize the NatureCounts data once more to get the annual total counts of Whooping Cranes:

```{r}
cranes_summary <- species_occurrence_summary %>%
  st_drop_geometry() %>%
  mutate(year = lubridate::year(date)) %>%
  group_by(year) %>%
  summarize(annual_count = sum(total_count, na.rm = TRUE)) %>%
  filter(!is.na(year)) %>%
  filter(year >= 1985 & year <= 2023)
cranes_summary
```

# 2.2 Preparing Climate Data

`weathercan` is an R package designed to help access historical weather data from ECCC. Steffi LaZerte's online tutorial, [Integrating data from weathercan](https://ropensci.org/blog/2018/03/06/weathercan/), provides more details on how to download, filter, and visualize weather data in R.

First, let's take a look at the built in **stations** dataset:

```{r}
stations <- weathercan::stations()
head(stations)
```

Next we can filter the weather data based on province and only include Alberta (AB) stations:

```{r}
prov_stations <- stations %>%
  filter(prov %in% c("AB"),
         interval == "day",
         end >= 2023)
```

We'll now perform a large weather data download that spans the survey years represented in the `cranes_summary` data:

```{r}
weather <- weather_dl(station_ids = prov_stations$station_id,
                         start = "1985-01-01",
                         end = "2024-01-01",
                         interval = "day", quiet = TRUE)
```

Now we need to convert the date column to Date data type. This will allow us to apply more filters based on month and survey year:

```{r}
weather$date <- as.Date(weather$date)
```

Finally, We'll summarize the weather data by calculating the yearly mean summer temperature and precipitation:

```{r}
yearly_climate <- weather %>%
  filter(lubridate::month(date) %in% 5:8) %>%  # Filter for summer months May (5) through August (8)
  group_by(year = lubridate::year(date)) %>%   # Group by year
  summarize(
    yearly_avg_temp = mean(mean_temp, na.rm = TRUE),
    yearly_avg_precip = mean(total_precip, na.rm = TRUE)
  )
```

# 2.3 Climate Data Analysis

Now that we have prepared our NatureCounts and Climate data, we can compile our tables together for analysis:

```{r}
cranes_climate_summary <- left_join(cranes_summary, yearly_climate)
cranes_climate_summary
```

```{r}
ggplot(cranes_climate_summary, aes(x = yearly_avg_temp, y = annual_count)) +
  geom_point(color = "blue", size = 3, alpha = 0.7) +  # Simple blue points
  geom_smooth(method = "lm", se = FALSE, color = "red") +  # Add linear regression line
  theme_minimal() +
  labs(x = "Avg Temperature (Â°C)", 
       y = "Total Count", 
       title = "Whooping Crane Count vs. Annual Avg Summer Temp") +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title
```

```{r}
ggplot(cranes_climate_summary, aes(x = yearly_avg_precip, y = annual_count)) +
  geom_point(color = "blue", size = 3, alpha = 0.7) +  # Simple blue points
  geom_smooth(method = "lm", se = FALSE, color = "red") +  # Add linear regression line
  theme_minimal() +
  labs(x = "Avg Precipitation", 
       y = "Total Count", 
       title = "Whooping Crane Count vs. Annual Avg Summer Precip") +
  theme(plot.title = element_text(hjust = 0.5))  # Center the title
```

# 2.4 Local Weather Scenario

To get a more local weather summary, say near the Whooping Crane KBA, we can filter the weather data download to include only those stations within a defined radius. To do, we can identify the centre coordinate among species occurrences within the KBA which will then be used to inform our search:

Convert the NatureCounts data from section 2.1 to a spatial object using the lat/lon coordinates:

```{r}
cranes_sf <- sf::st_as_sf(species_occurrence_summary, coords = c("longitude", "latitude"), crs = 4326)
```

Read in the KBA boundary:

```{r}
kba <- sf::st_read("Data/KBA/WhoopingCrane_KBA/whooping_crane_kba.shp")
```

Eliminate the unnecessary duplicate geometry:

```{r}
kba <- kba %>% st_make_valid() %>% distinct()
```

To perform an intersection, we first have to reproject our Whooping Crane and KBA spatial data layers using the `st_transform` function:

```{r}
# 
kba <- sf::st_transform(kba, crs = 26916) 

#
cranes_sf <- st_transform(cranes_sf, crs = st_crs(kba))
```

Perform an intersection to find which observations are within the target KBA using the `st_intersection` geoprocessing function:

```{r}
kba_cranes <- sf::st_intersection(kba, cranes_sf)
```

Calculate the center coordinate using the resulting occurrences from the intersection:

```{r}
centre_coord <- st_centroid(st_union(kba_cranes))
st_coordinates(centre_coord)
```

Search for the weather stations near this center coordinate:

```{r}
KBA_stations <- stations_search(coords = c(59.96507, -113.121), 
                         interval = "day", dist = 25) %>%
  filter(end >= 2009)
KBA_stations
```

Lastly, we can filter our larger weather data download to only include local weather stations:

```{r}
kba_weather <- weather %>%
  filter(station_id %in% KBA_stations$station_id)
```

Transform both spatial data layers back to a CRS suitable for mapping:

```{r}
kba <- st_transform(kba, crs = 4326)
kba_cranes <- st_transform(kba_cranes, crs = 4326)
```

Visualize the Whooping Crane observations within the KBA:

```{r}
leaflet(width = "100%") %>%
  addTiles() %>%
  addPolygons(data = kba, color = "black", weight = 2, smoothFactor = 1,
              opacity = 1.0, fillOpacity = 0.6, fillColor = "limegreen") %>%
   addCircleMarkers(data = kba_cranes, radius = 3, color = "black", stroke = FALSE, fillOpacity = 0.8) %>%
  addFullscreenControl() %>%
  addLegend(colors = c("black", "limegreen"), 
            labels = c("Whooping Crane observations", "KBA boundary"), 
            position = "bottomright") %>%
  addScaleBar(position = "bottomleft", options = scaleBarOptions(imperial = FALSE))
```

# 2.5 Climate Change Assessment Tools

In this next section we will manipulate more Climate data but in raster form to demonstrate how you might read in more bioclimatic variables and associate them with NatureCounts data.

```{r}
worldclim_list <- list.files(path = "C:/Users/dimit/Birds Canada/NatureCounts_SpatialData_Tutorial/Data/worldclim", pattern = "\\.tif$", full.names = TRUE)

# Read and stack the raster files
worldclim_stack <- rast(worldclim_list)

# Print information about the stack
print(worldclim_stack)

```

Great! Our raster stack including the 19 bio-climatic variables has been read into R successfully. It would help if we simplify our layer names which represent each variable, respectively.:

```{r}
names(worldclim_stack) <- paste0("bio", 1:19)
```

Let's take a look at our first layer 'bio1' which is Annual Mean Temperature. To do so, we can subset the layers of our SpatRaster with \$ or two sets of square brackets [ [ ] ].

```{r}
# Plot the first bioclimatic layer (e.g., bio1: Annual Mean Temperature)
plot(worldclim_stack[["bio1"]], main = "Annual Mean Temperature (bio1)")

# Summary statistics for each layer
summary(worldclim_stack)
```

We can now extract the value of each bioclimatic variable for each bird observation site, respectively. First we'll filter the `cranes_sf` dataset to only include observations from 1950 to present:

```{r}
cranes_sf_filtered <- cranes_sf %>%
  mutate(date = as.Date(date)) %>%
  filter(year(date) >= "1950")
```

```{r}
bioclim_values <- extract(worldclim_stack, cranes_sf_filtered)
```

Then combine the bioclimatic values with the NatureCounts data:

```{r}
bioclim_data <- cbind(cranes_sf_filtered, bioclim_values, species_occurrence_summary$longitude, species_occurrence_summary$latitude)
```

```{r}
library(ggplot2)

# Scatter plot of bird observations against a bioclimatic variable (bio1)
ggplot(data = bioclim_data, aes(x = bio15, y = total_count)) +
  geom_point(alpha = 0.6) +
  labs(title = "Bird Observations vs. Bioclimatic Variable (bio1)",
       x = "Bioclimatic Variable",
       y = "ObservationCount") +
  theme_minimal()

```

```{r}
bioclim_data <- st_transform(bioclim_data, crs = 4326)
```

```{r}
# Assuming bioclim_data is an sf object with total_count and bio1 columns
# Create a color palette for bio1 values
pal <- colorNumeric(palette = "viridis", domain = bioclim_data$bio1)

leaflet(data = bioclim_data) %>%
  addTiles() %>%
  addCircles(radius = ~total_count * 10, # Adjust the radius based on counts
             color = ~pal(bio1),         # Color based on bio1 values
             fillOpacity = 0.5, 
             stroke = TRUE,               # Optional: add stroke around circles
             weight = 1) %>%
  addLegend("bottomright", 
            pal = pal,                   # Use the same palette for the legend
            values = bioclim_data$bio1,
            title = "Bioclimatic Variable (bio1)",
            opacity = 1)
```

```{r}
library(ggplot2)
library(sf)

# Plotting the bird observation points
ggplot(data = bioclim_data) +
  geom_sf(aes(color = bio1), size = 2, shape = 21) +  # Use geometry directly
  scale_color_viridis_c() +  # Optional: Color scale for the bioclimatic variable
  labs(title = "Bird Observations with Bioclimatic Variable (bio1)",
       color = "Bioclimatic Variable (bio1)") +
  theme_minimal()

```

```{r}
write.csv(species_occurrence_summary, file = "Data/species_occurence_summary", row.names = FALSE)
```

```{r}
write.csv(yearly_climate, file = "Data/yearly_climate", row.names = FALSE)
```

```{r}
# Writing a compressed .csv file using gzip
write.csv(weather, gzfile("Data/weather.csv.gz"), row.names = FALSE)

```
